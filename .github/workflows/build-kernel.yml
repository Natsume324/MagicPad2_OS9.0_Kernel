name: Build Android Kernel

on:
  workflow_dispatch: # 手动触发构建

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
          git git-lfs gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
          libelf-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 \
          libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
          adb fastboot

      - name: Fetch Android 15 Clang
        run: |
          mkdir -p $GITHUB_WORKSPACE/clang
          # 拉取 Android 15 对应的 Clang 版本 (r522817 为 Android 15 常用版本)
          # 注意：这里直接从 AOSP 预编译仓库下载单分支以节省空间
          git clone --depth=1 -b android15-release https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 $GITHUB_WORKSPACE/clang

      - name: Build Kernel
        run: |
          # 1. 设置环境变量
          export PATH=$GITHUB_WORKSPACE/clang/clang-r522817/bin:$PATH
          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_COMPAT=arm-linux-gnueabi-
          
          # 2. 准备输出目录
          mkdir -p out
          
          # 3. 配置并编译
          # 假设你的 defconfig 是 gki_defconfig，如果不是请修改
          make O=out gki_defconfig
          make -j$(nproc) O=out \
               CC=clang \
               LD=ld.lld \
               AR=llvm-ar \
               NM=llvm-nm \
               OBJCOPY=llvm-objcopy \
               OBJDUMP=llvm-objdump \
               STRIP=llvm-strip

      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Image-GKI
          path: out/arch/arm64/boot/Image
