name: Build Android Kernel

on:
  workflow_dispatch:        # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-22.04   # 明确使用 Ubuntu 22.04 LTS

    steps:
      # 1. 检出内核源码
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. 安装编译依赖（包含你列出的所有包）
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc \
            bison \
            build-essential \
            ccache \
            curl \
            flex \
            g++-multilib \
            gcc-multilib \
            git \
            git-lfs \
            gnupg \
            gperf \
            imagemagick \
            lib32ncurses5-dev \
            lib32readline-dev \
            lib32z1-dev \
            libelf-dev \
            liblz4-tool \
            libncurses5 \
            libncurses5-dev \
            libsdl1.2-dev \
            libssl-dev \
            libxml2 \
            libxml2-utils \
            lzop \
            pngcrush \
            rsync \
            schedtool \
            squashfs-tools \
            xsltproc \
            zip \
            zlib1g-dev \
            adb \
            fastboot

      # 3. 缓存 NDK 工具链（加速后续构建）
      - name: Cache NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: /opt/ndk
          key: ndk-r27d-linux

      # 4. 如果缓存未命中，下载并解压 NDK r27d
      - name: Download and extract NDK (if not cached)
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          sudo mkdir -p /opt/ndk
          sudo chown $USER:$USER /opt/ndk
          wget -q https://dl.google.com/android/repository/android-ndk-r27d-linux.zip
          unzip -q android-ndk-r27d-linux.zip -d /opt/ndk
          mv /opt/ndk/android-ndk-r27d/* /opt/ndk/
          rm -rf /opt/ndk/android-ndk-r27d android-ndk-r27d-linux.zip

      # 5. 设置 NDK 环境变量（将工具链路径加入 PATH）
      - name: Set NDK environment
        run: |
          NDK_TOOLCHAIN_DIR="/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin"
          echo "NDK_TOOLCHAIN_DIR=$NDK_TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "$NDK_TOOLCHAIN_DIR" >> $GITHUB_PATH

      # 6. 确保构建脚本可执行
      - name: Make build.sh executable
        run: chmod +x build.sh

      # 7. 执行内核编译
      - name: Build kernel
        run: ./build.sh

      # 8. 上传构建产物（内核镜像、dtbo、日志等）
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: |
            out/arch/arm64/boot/Image.gz
            out/arch/arm64/boot/Image
            out/arch/arm64/boot/dtbo*.img
            build.log
          if-no-files-found: warn
